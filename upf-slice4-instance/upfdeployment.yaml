apiVersion: workload.nephio.org/v1alpha1
kind: NFDeployment
metadata: # kpt-merge: upf-slice4-instance/upf-slice4-instance
  name: upf-slice4-edge-1
  namespace: upf-slice4-instance
  labels:
    nephio.org/site: edge-1
    nephio.org/nf-type: upf
    intent-category: deployment
    domain: free5gc
    nf: upf
  annotations:
    # 这行你原来就有，保留即可（表示从上游包来的对象标识）
    internal.kpt.dev/upstream-identifier: 'workload.nephio.org|NFDeployment|upf-example|upf-example'
spec:
  provider: upf.free5gc.io

  # 1) 镜像与Pod模板（核心：容器镜像、资源、挂载free5gc upf配置、暴露必要能力）
  template:
    metadata:
      labels:
        app.kubernetes.io/name: upf
        app.kubernetes.io/part-of: free5gc
        app.kubernetes.io/component: upf
    spec:
      # 2) 接口绑定到 NAD：通过 Multus NAD 附加 N3/N6（示例用两个 NAD）
      #    注意：NAD 名称要与你集群里已有 NAD 一致（通常在同命名空间，或按你策略引用）
      networkAttachments:
        - name: nad-n3    # N3 (gNB<->UPF)
          interfaceName: n3
        - name: nad-n6    # N6 (UPF<->Data Network)
          interfaceName: n6

      containers:
        - name: upf
          image: free5gc/upf:v3.3.0
          imagePullPolicy: IfNotPresent

          # 3) 资源：按你 slice4 需求调（这里只给一个常用中等配置）
          resources:
            requests:
              cpu: "2"
              memory: "2Gi"
            limits:
              cpu: "4"
              memory: "4Gi"

          securityContext:
            privileged: true
            allowPrivilegeEscalation: true
            capabilities:
              add:
                - NET_ADMIN
                - SYS_ADMIN

          # 4) 挂载 free5gc UPF 配置
          volumeMounts:
            - name: upf-config
              mountPath: /free5gc/config
              readOnly: true

          env:
            # 可选：你也可以用 env 覆盖一些值（如果你的 upf 镜像支持）
            - name: GIN_MODE
              value: "release"

      volumes:
        - name: upf-config
          configMap:
            name: upf-slice4-config

  # 5) DNN/路由：将“DNN -> N6 路由/下一跳/NAT策略”等写清楚
  #    这里我用“dnnRouting”表达（你可按仓库的 CRD 字段改名）
  dnnRouting:
    - dnn: internet
      n6Interface: n6
      # 下面两种写法二选一：
      # A) 你有默认网关（常见于桥接到外网/上联网关）
      gateway: 10.10.6.1
      # B) 或者你直接指定静态路由（示例）
      routes:
        - dst: 0.0.0.0/0
          gw: 10.10.6.1
    - dnn: edge
      n6Interface: n6
      routes:
        - dst: 172.20.0.0/16
          gw: 10.10.6.1

  # 6) free5gc UPF 必要配置：用 values/config 方式下发（常见是 ConfigMap + 引用）
  #    这里直接内置一个 configMap 资源，方便你“一份文件表达完整意图”
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: upf-slice4-config
  namespace: upf-slice4-instance
data:
  upfcfg.yaml: |
    # free5gc UPF config (示例：按 v3.x 常见结构写)
    version: "1.0.3"
    description: "UPF slice4 on edge-1"

    # PFCP 服务地址：UPF 用它和 SMF 建 PFCP 会话
    pfcp:
      # UPF 的 PFCP endpoint（通常走 N4 管理网/或默认网卡）
      addr: 10.10.4.21

    # GTP-U：N3 面（gNB 到 UPF 的用户面隧道）
    gtpu:
      forwarder: gtp5g
      ifList:
        - addr: 10.10.3.21      # N3 上 UPF 的IP
          name: n3

    # DNN 列表与 UE 地址池（可按 slice4 改）
    dnnList:
      - dnn: internet
        cidr: 10.60.0.0/16
        # N6 出口与 NAT（如果你需要 UE 上网通常要 NAT）
        natifname: n6
      - dnn: edge
        cidr: 10.61.0.0/16
        natifname: n6

    # 日志（可选）
    logger:
      enable: true
      level: info

  # 可选：如果你的 UPF 镜像需要额外脚本/路由初始化，也可以写进来
  entrypoint.sh: |
    #!/bin/sh
    set -e

    echo "[UPF] applying routes for DNNs..."
    # 示例：确保默认路由走 N6 网关（按你的网关改）
    ip route replace default via 10.10.6.1 dev n6 || true

    echo "[UPF] starting upf..."
    /free5gc/upf -c /free5gc/config/upfcfg.yaml
